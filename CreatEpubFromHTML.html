<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
    <title>EPUB Creator Userscript</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-top: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .drop-area {
            border: 3px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background-color: #e8f4fc;
            margin-bottom: 25px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .drop-area:hover, .drop-area.drag-over {
            background-color: #d1e8ff;
            border-color: #2980b9;
        }
        
        .drop-area p {
            margin: 0;
            font-size: 18px;
            color: #3498db;
        }
        
        .drop-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
            display: block;
        }
        
        .file-list {
            margin: 25px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .file-list-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            display: grid;
            grid-template-columns: 1fr 120px 100px;
            gap: 15px;
        }
        
        .file-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 120px 100px;
            gap: 15px;
            transition: background-color 0.2s;
        }
        
        .file-item:hover {
            background-color: #f9f9f9;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-name {
            word-break: break-all;
        }
        
        .file-size, .file-modified {
            text-align: right;
            color: #666;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            min-height: 24px;
            font-weight: 500;
        }
        
        .progress-container {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin: 30px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>T·∫°o EPUB t·ª´ HTML</h1>
        <div>
    <a href="index.html">Quay v·ªÅ</a>
  </div>
        
        <div class="drop-area" id="dropArea">
            <i>üìÅ</i>
            <p>K√©o v√† th·∫£ file HTML v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file</p>
            <input type="file" id="fileInput" accept=".html,.htm" multiple style="display: none;">
        </div>
        
        <div class="file-list" id="fileList" style="display: none;">
            <div class="file-list-header">
                <div class="file-name">T√™n file</div>
                <div class="file-size">K√≠ch th∆∞·ªõc</div>
                <div class="file-modified">Ng√†y s·ª≠a</div>
            </div>
            <div id="fileItems"></div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="actions">
            <button class="btn btn-primary" id="createEpubBtn" disabled>
                <span id="buttonText">T·∫°o EPUB</span>
            </button>
            <button class="btn btn-secondary" id="clearBtn" disabled>X√≥a t·∫•t c·∫£</button>
        </div>
    </div>

    <script>
        // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
        let htmlFiles = [];
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileItems = document.getElementById('fileItems');
        const createEpubBtn = document.getElementById('createEpubBtn');
        const clearBtn = document.getElementById('clearBtn');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const buttonText = document.getElementById('buttonText');

        // S·ª± ki·ªán khi k√©o file v√†o khu v·ª±c
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('drag-over');
        }

        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }

        // S·ª± ki·ªán khi th·∫£ file
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // S·ª± ki·ªán khi click v√†o khu v·ª±c th·∫£ file
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        // S·ª± ki·ªán khi ch·ªçn file qua input
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        // X·ª≠ l√Ω file ƒë∆∞·ª£c ch·ªçn
        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => 
                file.type === 'text/html' || file.name.toLowerCase().endsWith('.html') || file.name.toLowerCase().endsWith('.htm')
            );
            
            if (newFiles.length === 0) {
                status.textContent = 'Vui l√≤ng ch·ªçn file HTML (.html ho·∫∑c .htm)';
                return;
            }
            
            // Th√™m file m·ªõi v√†o danh s√°ch
            htmlFiles = htmlFiles.concat(newFiles);
            
            // S·∫Øp x·∫øp file theo ng√†y s·ª≠a ƒë·ªïi (c≈© nh·∫•t tr∆∞·ªõc)
            htmlFiles.sort((a, b) => a.lastModified - b.lastModified);
            
            // Hi·ªÉn th·ªã danh s√°ch file
            renderFileList();
            
            // Hi·ªÉn th·ªã danh s√°ch file
            fileList.style.display = 'block';
            
            // K√≠ch ho·∫°t n√∫t t·∫°o EPUB v√† x√≥a
            createEpubBtn.disabled = false;
            clearBtn.disabled = false;
            
            status.textContent = `ƒê√£ ch·ªçn ${htmlFiles.length} file HTML. S·∫Øp x·∫øp theo ng√†y s·ª≠a ƒë·ªïi.`;
        }

        // Hi·ªÉn th·ªã danh s√°ch file
        function renderFileList() {
            fileItems.innerHTML = '';
            
            htmlFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileSize = formatFileSize(file.size);
                const modifiedDate = formatDate(file.lastModified);
                
                fileItem.innerHTML = `
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                    <div class="file-modified">${modifiedDate}</div>
                `;
                
                fileItems.appendChild(fileItem);
            });
        }

        // ƒê·ªãnh d·∫°ng k√≠ch th∆∞·ªõc file
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ƒê·ªãnh d·∫°ng ng√†y th√°ng
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // S·ª± ki·ªán khi nh·∫•n n√∫t X√≥a t·∫•t c·∫£
        clearBtn.addEventListener('click', () => {
            htmlFiles = [];
            fileList.style.display = 'none';
            createEpubBtn.disabled = true;
            clearBtn.disabled = true;
            status.textContent = 'ƒê√£ x√≥a t·∫•t c·∫£ file. Vui l√≤ng ch·ªçn file m·ªõi.';
        });

        // S·ª± ki·ªán khi nh·∫•n n√∫t T·∫°o EPUB
        createEpubBtn.addEventListener('click', async () => {
            if (htmlFiles.length === 0) {
                status.textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file HTML.';
                return;
            }
            
            // ·∫®n n√∫t v√† hi·ªÉn th·ªã thanh ti·∫øn tr√¨nh
            createEpubBtn.disabled = true;
            clearBtn.disabled = true;
            buttonText.innerHTML = '<span class="loading"></span> ƒêang t·∫°o EPUB...';
            progressContainer.style.display = 'block';
            status.textContent = 'ƒêang x·ª≠ l√Ω c√°c file HTML...';
            
            try {
                // T·∫°o EPUB
                const epubBlob = await createEpub();
                
                // T·∫£i xu·ªëng file
                const fileName = getFileNameWithoutExtension(htmlFiles[0].name) + '.epub';
                downloadFile(epubBlob, fileName);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                status.textContent = `ƒê√£ t·∫°o th√†nh c√¥ng file EPUB: ${fileName}`;
                progressBar.style.width = '100%';
                
                // ƒê·∫∑t l·∫°i n√∫t sau 2 gi√¢y
                setTimeout(() => {
                    buttonText.textContent = 'T·∫°o EPUB';
                    progressContainer.style.display = 'none';
                    createEpubBtn.disabled = false;
                    clearBtn.disabled = false;
                    progressBar.style.width = '0%';
                }, 2000);
            } catch (error) {
                status.textContent = 'L·ªói khi t·∫°o EPUB: ' + error.message;
                buttonText.textContent = 'T·∫°o EPUB';
                createEpubBtn.disabled = false;
                clearBtn.disabled = false;
                progressContainer.style.display = 'none';
            }
        });

        // L·∫•y t√™n file kh√¥ng c√≥ ph·∫ßn m·ªü r·ªông
        function getFileNameWithoutExtension(fileName) {
            return fileName.replace(/\.[^/.]+$/, "");
        }

        // T·∫°o file EPUB
        async function createEpub() {
            // T·∫°o ƒë·ªëi t∆∞·ª£ng JSZip
            const zip = new JSZip();
            
            // Th√™m mimetype (ph·∫£i l√† file ƒë·∫ßu ti√™n v√† kh√¥ng n√©n)
            zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
            
            // T·∫°o th∆∞ m·ª•c META-INF
            const metaInf = zip.folder("META-INF");
            metaInf.file("container.xml", `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
            
            // T·∫°o th∆∞ m·ª•c OEBPS
            const oebps = zip.folder("OEBPS");
            
            // T·∫°o content.opf
            let manifestItems = '';
            let spineItems = '';
            let tocItems = '';
            
            // T·∫°o UUID cho EPUB
            const uuid = generateUUID();
            const bookTitle = getFileNameWithoutExtension(htmlFiles[0].name);
            
            // X·ª≠ l√Ω t·ª´ng file HTML theo th·ª© t·ª±
            for (let i = 0; i < htmlFiles.length; i++) {
                const file = htmlFiles[i];
                const fileName = `chapter${i + 1}.xhtml`;
                const itemId = `item${i + 1}`;
                
                // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
                progressBar.style.width = `${((i + 1) / htmlFiles.length) * 100}%`;
                status.textContent = `ƒêang x·ª≠ l√Ω file ${i + 1}/${htmlFiles.length}: ${file.name}`;
                
                // ƒê·ªçc n·ªôi dung file
                const content = await readFile(file);
                
                // T·∫°o file XHTML
                const xhtmlContent = createXHTML(file.name, content);
                oebps.file(fileName, xhtmlContent);
                
                // Th√™m v√†o manifest
                manifestItems += `<item id="${itemId}" href="${fileName}" media-type="application/xhtml+xml"/>\n`;
                
                // Th√™m v√†o spine
                spineItems += `<itemref idref="${itemId}"/>\n`;
                
                // Th√™m v√†o toc
                tocItems += `<navPoint id="nav${i + 1}" playOrder="${i + 1}">
  <navLabel><text>${file.name}</text></navLabel>
  <content src="${fileName}"/>
</navPoint>\n`;
            }
            
            // T·∫°o content.opf
            const contentOpf = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="BookId">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="BookId">urn:uuid:${uuid}</dc:identifier>
    <dc:title>${bookTitle}</dc:title>
    <dc:language>vi</dc:language>
  </metadata>
  <manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${manifestItems}
  </manifest>
  <spine toc="ncx">
    ${spineItems}
  </spine>
</package>`;
            
            oebps.file("content.opf", contentOpf);
            
            // T·∫°o toc.ncx
            const tocNcx = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${uuid}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle>
    <text>${bookTitle}</text>
  </docTitle>
  <navMap>
    ${tocItems}
  </navMap>
</ncx>`;
            
            oebps.file("toc.ncx", tocNcx);
            
            // T·∫°o file ZIP
            return await zip.generateAsync({ type: "blob" }, metadata => {
                progressBar.style.width = `${metadata.percent}%`;
            });
        }

        // ƒê·ªçc file d∆∞·ªõi d·∫°ng text
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // T·∫°o n·ªôi dung XHTML t·ª´ HTML
        function createXHTML(title, htmlContent) {
            // Lo·∫°i b·ªè c√°c th·∫ª HTML kh√¥ng c·∫ßn thi·∫øt
            const cleanContent = htmlContent
                .replace(/<!DOCTYPE[^>]*>/i, '')
                .replace(/<html[^>]*>/i, '')
                .replace(/<\/html>/i, '')
                .replace(/<head[^>]*>[\s\S]*?<\/head>/i, '')
                .replace(/<body[^>]*>/i, '')
                .replace(/<\/body>/i, '');
            
            return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>${title}</title>
</head>
<body>
${cleanContent}
</body>
</html>`;
        }

        // T·∫°o UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // T·∫£i file xu·ªëng
        function downloadFile(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // T·∫£i JSZip n·∫øu ch∆∞a c√≥
        function loadJSZip() {
            return new Promise((resolve, reject) => {
                if (typeof JSZip !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        (async function init() {
            status.textContent = 'ƒêang t·∫£i th∆∞ vi·ªán JSZip...';
            try {
                await loadJSZip();
                status.textContent = 'S·∫µn s√†ng. Vui l√≤ng ch·ªçn file HTML.';
            } catch (error) {
                status.textContent = 'Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán JSZip. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.';
            }
        })();
    </script>
</body>
</html>