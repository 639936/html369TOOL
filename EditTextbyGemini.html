<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xử lý văn bản với Gemini AI (Lưu API Key)</title>
  
  <meta name="theme-color" content="#2e86de">

  <style>
    /* ... TOÀN BỘ CSS GIỮ NGUYÊN NHƯ CŨ ... */
    :root {
        --primary-color: #2e86de;
        --secondary-color: #f2f4f8;
        --text-color: #333;
        --border-color: #dce1e6;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--secondary-color);
      color: var(--text-color);
      padding: 20px;
      margin: 0;
    }
    main { max-width: 800px; margin: 0 auto; }
    h1 { color: #4a90e2; font-size: 2.5em; margin-bottom: 20px; text-align: center; }
    p { font-size: 1.1em; line-height: 1.6; margin-bottom: 30px; text-align: center; }
    .card {
      background-color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin: 20px auto; padding: 25px; text-align: left;
    }
    h2 {
      font-size: 1.4em; margin-top: 0; margin-bottom: 20px; color: var(--primary-color);
      border-bottom: 2px solid #eef2f7; padding-bottom: 10px;
    }
    label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
    input[type="text"], input[type="password"], input[type="file"], input[type="number"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
      box-sizing: border-box; margin-bottom: 15px; font-family: inherit; font-size: 1em;
    }
    textarea { resize: vertical; }
    button {
      display: block; width: 100%; background-color: var(--primary-color); color: white;
      text-decoration: none; padding: 12px 20px; border-radius: 4px; border: none;
      font-size: 1.1em; font-weight: bold; cursor: pointer;
      margin-top: 10px; transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) { background-color: #1b4f72; }
    button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    .or-separator { text-align: center; margin: 15px 0; font-weight: bold; color: #777; }
    details { border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; }
    summary { font-weight: bold; cursor: pointer; color: var(--primary-color); }
    .advanced-settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    .form-group { display: flex; flex-direction: column; }
    .range-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
    .range-group input[type="range"] { flex-grow: 1; padding: 0; margin-bottom: 0; }
    .range-group .value-display { font-weight: bold; min-width: 35px; text-align: right; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; padding-top: 10px; }
    .checkbox-group input { width: auto; margin-bottom: 0; }
    .checkbox-group label { margin-bottom: 0; }
    #result-card pre {
      background-color: #eef2f7; padding: 15px; border-radius: 4px;
      white-space: pre-wrap; word-wrap: break-word; min-height: 100px;
      font-family: 'Courier New', Courier, monospace;
    }
    #loading-indicator { display: none; text-align: center; color: var(--primary-color); font-weight: bold; }
  </style>
</head>
<body>

  <main>
    <!-- ... TOÀN BỘ PHẦN HTML TRONG BODY GIỮ NGUYÊN ... -->
    <h1>Xử lý văn bản với Gemini AI</h1>
    <p>Nhập văn bản, API key, prompt và nhận kết quả xử lý trực tiếp từ Gemini.</p>

    <!-- CARD 1: INPUT TEXT -->
    <div class="card">
      <h2>1. Cung cấp văn bản cần xử lý</h2>
      <label for="textInput">Nhập văn bản vào ô dưới đây:</label>
      <textarea id="textInput" rows="10" placeholder="Nhập hoặc dán văn bản của bạn vào đây..."></textarea>
      <div class="or-separator">HOẶC</div>
      <label for="fileInput">Tải lên tệp tin (.txt):</label>
      <input type="file" id="fileInput" accept=".txt">
    </div>

    <!-- CARD 2: API & PROMPT CONFIG -->
    <div class="card">
      <h2>2. Cấu hình API & Prompt</h2>
      <label for="apiKeyInput">API Key của bạn:</label>
      <input type="password" id="apiKeyInput" placeholder="Nhập API Key của bạn từ Google AI Studio" required>
      <label for="promptInput">Prompt (Yêu cầu):</label>
      <textarea id="promptInput" rows="4" required>Chỉ trả về văn bản đã xử lý. Giữ nguyên định dạng, bố cục của văn bản gốc.</textarea>
    </div>

    <!-- CARD 3: ADVANCED SETTINGS -->
    <div class="card">
        <details>
            <summary>Cài đặt nâng cao (Tùy chọn)</summary>
            <div class="advanced-settings-grid">
                <div class="form-group">
                    <label for="temperature">Temperature (Sáng tạo)</label>
                    <div class="range-group">
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.5">
                        <span id="temperature-value" class="value-display">0.5</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="top-p">Top-P</label>
                    <div class="range-group">
                        <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.95">
                        <span id="top-p-value" class="value-display">0.95</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="top-k">Top-K</label>
                    <input type="number" id="top-k" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="max-tokens">Max Output Tokens</label>
                    <input type="number" id="max-tokens" value="65536" min="1">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="disable-safety" style="width: auto;">
                        <label for="disable-safety">Tắt bộ lọc an toàn</label>
                    </div>
                </div>
            </div>
        </details>
    </div>
    
    <!-- CARD 4: SUBMIT & RESULT -->
    <div class="card" id="result-card">
      <button id="submitBtn">Gửi yêu cầu tới Gemini</button>
      <div id="loading-indicator">
        <p>Đang xử lý, vui lòng chờ...</p>
      </div>
      <h2>Kết quả từ Gemini</h2>
      <pre><code id="resultOutput">Kết quả sẽ được hiển thị ở đây.</code></pre>
    </div>
  </main>

  <!-- Import Google Generative AI SDK -->
  <script type="module">
    import {
      GoogleGenerativeAI,
      HarmCategory,
      HarmBlockThreshold,
    } from "https://esm.run/@google/generative-ai";

    // Lấy các element từ DOM
    const textInput = document.getElementById('textInput');
    const fileInput = document.getElementById('fileInput');
    const apiKeyInput = document.getElementById('apiKeyInput'); // <-- Biến này đã có sẵn
    const promptInput = document.getElementById('promptInput');
    const submitBtn = document.getElementById('submitBtn');
    const resultOutput = document.getElementById('resultOutput');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    const temperatureSlider = document.getElementById('temperature');
    const temperatureValue = document.getElementById('temperature-value');
    const topPSlider = document.getElementById('top-p');
    const topPValue = document.getElementById('top-p-value');
    const topKInput = document.getElementById('top-k');
    const maxTokensInput = document.getElementById('max-tokens');
    const disableSafetyCheckbox = document.getElementById('disable-safety');

    // --- PHẦN MÃ MỚI ĐỂ LƯU API KEY ---
    const API_KEY_STORAGE_KEY = 'geminiTextProcessor_apiKey';

    function saveApiKeyToStorage() {
        // Cảnh báo: API Key đang được lưu dưới dạng văn bản thuần túy.
        // Chỉ nên dùng cho mục đích cá nhân.
        localStorage.setItem(API_KEY_STORAGE_KEY, apiKeyInput.value);
    }

    function loadApiKeyFromStorage() {
        const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (savedKey) {
            apiKeyInput.value = savedKey;
            console.log('API Key đã được tải từ localStorage.');
        }
    }
    // --- KẾT THÚC PHẦN MÃ MỚI ---


    function updateSliderDisplay() {
        temperatureValue.textContent = temperatureSlider.value;
        topPValue.textContent = topPSlider.value;
    }

    // ... Toàn bộ các hàm khác như callGeminiApi, etc. giữ nguyên ...
    async function callGeminiApi() {
      const apiKey = apiKeyInput.value.trim();
      const userPrompt = promptInput.value.trim();
      const inputText = textInput.value.trim();

      if (!apiKey || !userPrompt || !inputText) {
        alert('Vui lòng điền đầy đủ API Key, Prompt và Văn bản cần xử lý.');
        return;
      }
      
      submitBtn.disabled = true;
      loadingIndicator.style.display = 'block';
      resultOutput.textContent = '';

      try {
        const genAI = new GoogleGenerativeAI(apiKey);
        
        const generationConfig = {
          temperature: parseFloat(temperatureSlider.value),
          topK: parseInt(topKInput.value, 10),
          topP: parseFloat(topPSlider.value),
          maxOutputTokens: parseInt(maxTokensInput.value, 10),
        };

        let safetySettings;
        if (disableSafetyCheckbox.checked) {
            safetySettings = [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            ];
        } else {
             safetySettings = [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
            ];
        }
        
        const model = genAI.getGenerativeModel({ 
            model: "gemini-2.5-flash",
            generationConfig,
            safetySettings
        });

        const fullPrompt = `${userPrompt}\n\n--- VĂN BẢN CẦN XỬ LÝ ---\n\n${inputText}`;

        const result = await model.generateContent(fullPrompt);
        const response = await result.response;
        const text = response.text();
        resultOutput.textContent = text;
        
      } catch (error) {
        console.error(error);
        resultOutput.textContent = `Đã xảy ra lỗi: ${error.message}\n\nVui lòng kiểm tra lại API Key, kết nối mạng và các cài đặt. Nếu yêu cầu bị chặn, hãy thử tắt bộ lọc an toàn.`;
      } finally {
        submitBtn.disabled = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // --- GẮN CÁC SỰ KIỆN ---

    // Chạy các hàm khởi tạo
    updateSliderDisplay();
    loadApiKeyFromStorage(); // <-- Tải key khi trang được mở

    // Gắn sự kiện cho các element
    apiKeyInput.addEventListener('input', saveApiKeyToStorage); // <-- Lưu key mỗi khi người dùng nhập
    temperatureSlider.addEventListener('input', updateSliderDisplay);
    topPSlider.addEventListener('input', updateSliderDisplay);
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) { return; }
      const reader = new FileReader();
      reader.onload = (e) => { textInput.value = e.target.result; };
      reader.readAsText(file);
    });
    submitBtn.addEventListener('click', callGeminiApi);

  </script>
</body>
</html>
