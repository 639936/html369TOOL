<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Novel Analyzer & Standardizer</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --primary-color: #2a2a2e;
            --secondary-color: #3a3a40;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --success-color: #7ed321;
            --error-color: #d0021b;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header, main {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        h3 {
            border: none;
            padding-bottom: 0;
            margin: 0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-panel, .file-panel {
            background-color: var(--primary-color);
            padding: 20px;
            border-radius: 8px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }

        details {
            background-color: var(--primary-color);
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        textarea {
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
            font-size: 14px;
            resize: vertical;
        }
        
        #outputName, #outputVp, #outputRule {
            min-height: 400px;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #357abd;
        }
        
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #555;
        }

        button.danger {
            background-color: var(--error-color);
        }
        button.danger:hover {
            background-color: #a00;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .options-group {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: 4px;
        }
        .options-group label {
            margin-left: 5px;
            cursor: pointer;
        }
        .options-group input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .drop-zone {
            border: 2px dashed var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            margin-top: 15px;
        }
        .drop-zone.dragover {
            background-color: var(--secondary-color);
            border-color: var(--accent-color);
        }
        .file-input-hidden {
            display: none;
        }

        .file-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .file-list li {
            background-color: var(--secondary-color);
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-list li::before {
            font-weight: bold;
        }
        .status-pending::before { content: '⏳'; }
        .status-processing::before { content: '⚙️'; animation: spin 1s linear infinite; }
        .status-success::before { content: '✅'; color: var(--success-color); }
        .status-failed::before { content: '❌'; color: var(--error-color); }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .output-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #progress-counter {
            font-weight: bold;
        }
        
        hr {
            border: none;
            border-top: 2px solid var(--secondary-color);
            margin: 40px 0;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>Gemini Novel Analyzer & Standardizer</h1>
    </header>
    <main>
         <div>
            <a href="index.html">Quay về</a>
        </div>
        <!-- GEMINI PROCESSING SECTION -->
        <section>
            <h2>Công cụ Khai thác Dữ liệu từ Gemini</h2>
            <div class="grid-container">
                <div class="settings-panel">
                    <details>
                        <summary>API Keys</summary>
                        <textarea id="apiKeysInput" placeholder="Dán mỗi API Key trên một dòng..."></textarea>
                    </details>
                    <details>
                        <summary>Prompt</summary>
                        <textarea id="promptInput"></textarea>
                    </details>
                </div>
                <div class="file-panel">
                    <h3>File cần xử lý <span id="progress-counter"></span></h3>
                    <div id="drop-zone-gemini" class="drop-zone">
                        Kéo và thả file (.txt, .html) vào đây, hoặc nhấn để chọn file
                        <input type="file" id="fileInput-gemini" class="file-input-hidden" multiple accept=".txt,.html,text/plain,text/html">
                    </div>
                     <ul id="fileList-gemini" class="file-list"></ul>
                </div>
            </div>

            <div class="full-width button-group">
                <button id="startBtn">Bắt đầu xử lý</button>
                <button id="resumeBtn" class="secondary">Tiếp tục xử lý file lỗi</button>
                <button id="saveStateBtn">Lưu phiên làm việc</button>
                <button id="clearStateBtn" class="danger">Xóa và làm mới</button>
            </div>

            <div class="full-width output-grid">
                <div class="output-area">
                    <div class="output-header"><h3>Tên Riêng (Name)</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('outputName')">Copy</button><button class="secondary" onclick="downloadAsFile('outputName', 'name.txt')">Tải về</button></div></div>
                    <textarea id="outputName" placeholder="Kết quả tên riêng sẽ hiện ở đây..."></textarea>
                </div>
                <div class="output-area">
                    <div class="output-header"><h3>Việt Phrase (VP)</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('outputVp')">Copy</button><button class="secondary" onclick="downloadAsFile('outputVp', 'vp.txt')">Tải về</button></div></div>
                    <textarea id="outputVp" placeholder="Kết quả Việt Phrase sẽ hiện ở đây..."></textarea>
                </div>
                <div class="output-area">
                     <div class="output-header"><h3>Luật Nhân (Rule)</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('outputRule')">Copy</button><button class="secondary" onclick="downloadAsFile('outputRule', 'rule.txt')">Tải về</button></div></div>
                    <textarea id="outputRule" placeholder="Kết quả luật nhân sẽ hiện ở đây..."></textarea>
                </div>
            </div>
        </section>

        <hr>

        <!-- STANDARDIZER SECTION -->
        <section>
            <h2>Công cụ Chuẩn hoá Dữ liệu</h2>
            
            <div class="options-group">
                <input type="checkbox" id="standardizer-remove-special-chars" checked>
                <label for="standardizer-remove-special-chars">Xóa dòng chứa ký tự đặc biệt khi chuẩn hóa</label>
            </div>

            <details>
                <summary>1. Chuẩn hóa Hàng loạt (Từ kết quả Gemini)</summary>
                <p>Công cụ này sẽ lấy dữ liệu từ 3 ô kết quả ở trên, áp dụng các bộ lọc nâng cao và hiển thị kết quả đã làm sạch ở dưới.</p>
                <div class="button-group">
                    <button id="runGeneratedStandardizerBtn">Bắt đầu chuẩn hoá hàng loạt</button>
                </div>
                <div class="full-width output-grid" style="margin-top: 20px;">
                    <div class="output-area">
                        <div class="output-header"><h3>Name đã chuẩn hoá</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('stdOutputName')">Copy</button><button class="secondary" onclick="downloadAsFile('stdOutputName', 'name_std.txt')">Tải về</button></div></div>
                        <textarea id="stdOutputName" placeholder="Hiển thị một phần kết quả..."></textarea>
                    </div>
                    <div class="output-area">
                        <div class="output-header"><h3>VP đã chuẩn hoá</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('stdOutputVp')">Copy</button><button class="secondary" onclick="downloadAsFile('stdOutputVp', 'vp_std.txt')">Tải về</button></div></div>
                        <textarea id="stdOutputVp" placeholder="Hiển thị một phần kết quả..."></textarea>
                    </div>
                    <div class="output-area">
                        <div class="output-header"><h3>Rule đã chuẩn hoá</h3><div class="button-group"><button class="secondary" onclick="copyToClipboard('stdOutputRule')">Copy</button><button class="secondary" onclick="downloadAsFile('stdOutputRule', 'rule_std.txt')">Tải về</button></div></div>
                        <textarea id="stdOutputRule" placeholder="Hiển thị một phần kết quả..."></textarea>
                    </div>
                </div>
            </details>

            <details>
                <summary>2. Chuẩn hóa thủ công File Tên (Name)</summary>
                <div id="standardizer-name">
                    <textarea placeholder="Dán nội dung Name vào đây..."></textarea>
                    <div class="drop-zone">Kéo thả hoặc chọn file Name (.txt)</div>
                    <input type="file" class="file-input-hidden" multiple accept=".txt,text/plain">
                    <ul class="file-list"></ul>
                    <div class="button-group"><button>Chuẩn hoá Name</button></div>
                    <div class="output-area" style="margin-top:20px;">
                        <div class="output-header"><h3>Kết quả Name</h3><div class="button-group"><button class="secondary">Copy</button><button class="secondary">Tải về</button></div></div>
                        <textarea class="manual-output-textarea" placeholder="Kết quả Name đã chuẩn hoá..."></textarea>
                    </div>
                </div>
            </details>

            <details>
                <summary>3. Chuẩn hóa thủ công File Việt Phrase (VP)</summary>
                <div id="standardizer-vp">
                    <textarea placeholder="Dán nội dung VP vào đây..."></textarea>
                    <div class="drop-zone">Kéo thả hoặc chọn file VP (.txt)</div>
                    <input type="file" class="file-input-hidden" multiple accept=".txt,text/plain">
                    <ul class="file-list"></ul>
                    <div class="button-group"><button>Chuẩn hoá VP</button></div>
                    <div class="output-area" style="margin-top:20px;">
                        <div class="output-header"><h3>Kết quả VP</h3><div class="button-group"><button class="secondary">Copy</button><button class="secondary">Tải về</button></div></div>
                        <textarea class="manual-output-textarea" placeholder="Kết quả VP đã chuẩn hoá..."></textarea>
                    </div>
                </div>
            </details>

            <details>
                <summary>4. Chuẩn hóa thủ công File Luật (Rule)</summary>
                 <div id="standardizer-rule">
                    <textarea placeholder="Dán nội dung Rule vào đây..."></textarea>
                    <div class="drop-zone">Kéo thả hoặc chọn file Rule (.txt)</div>
                    <input type="file" class="file-input-hidden" multiple accept=".txt,text/plain">
                    <ul class="file-list"></ul>
                    <div class="button-group"><button>Chuẩn hoá Rule</button></div>
                    <div class="output-area" style="margin-top:20px;">
                        <div class="output-header"><h3>Kết quả Rule</h3><div class="button-group"><button class="secondary">Copy</button><button class="secondary">Tải về</button></div></div>
                        <textarea class="manual-output-textarea" placeholder="Kết quả Rule đã chuẩn hoá..."></textarea>
                    </div>
                </div>
            </details>

        </section>
    <div>
            <a href="CreatVPNames.html">Reload</a>
        </div>
    </main>

        <script>
        // --- DOM Elements ---
        const apiKeysInput = document.getElementById('apiKeysInput');
        const promptInput = document.getElementById('promptInput');
        const dropZoneGemini = document.getElementById('drop-zone-gemini');
        const fileInputGemini = document.getElementById('fileInput-gemini');
        const fileListGemini = document.getElementById('fileList-gemini');
        const startBtn = document.getElementById('startBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const saveStateBtn = document.getElementById('saveStateBtn');
        const clearStateBtn = document.getElementById('clearStateBtn');
        const progressCounter = document.getElementById('progress-counter');
        const outputName = document.getElementById('outputName');
        const outputVp = document.getElementById('outputVp');
        const outputRule = document.getElementById('outputRule');
        
        // Standardizer Elements
        const runGeneratedStandardizerBtn = document.getElementById('runGeneratedStandardizerBtn');
        const stdOutputName = document.getElementById('stdOutputName');
        const stdOutputVp = document.getElementById('stdOutputVp');
        const stdOutputRule = document.getElementById('stdOutputRule');
        const removeSpecialCharsToggle = document.getElementById('standardizer-remove-special-chars');


        // --- State Variables ---
        let filesToProcess = [];
        let isProcessing = false;
        
        const DEFAULT_PROMPT = `Mục tiêu: Phân tích văn bản tiếng Trung, trích xuất và dịch các thành phần cụ thể theo yêu cầu.\n\nYêu cầu chi tiết:\n\n1.  **Nhiệm vụ Phân tích**: Từ văn bản đầu vào, thực hiện ba nhiệm vụ sau:\n       **Nhiệm vụ 1: Dịch Tên**: Tìm tất cả tên riêng (tên người, địa danh, môn phái, công pháp, chiêu thức), danh từ chung và dịch chúng sang Hán Việt.\n       **Nhiệm vụ 2: Dịch Cụm Từ (Viet Phrase)**: Tìm các cụm từ hoặc cấu trúc câu phổ biến (không quá 6 ký tự) và dịch sang tiếng Việt tự nhiên, dễ hiểu, giữ văn phong cổ trang.\n       **Nhiệm vụ 3: Tạo Luật Nhân**: Tìm các cấu trúc có chứa số hoặc danh từ có thể thay thế, cấu trúc không lớn hơn 6 ký tự, để tạo ra quy tắc chung, quy tắc cần dễ hiểu, sử dụng placeholder {0}, {1}.\n\n2.  **Định dạng đầu ra BẮT BUỘC**:\n    *   Kết quả phải là văn bản thuần túy, KHÔNG được chứa markdown hay bất kỳ lời giải thích nào.\n    *   Nội dung kết quả phải được chia thành BA phần, bắt đầu bằng các tiêu đề: "- tên:", "- việt phrase:", "- luật nhân:". kết quả dịch chỉ sử dụng ký tự in hoa hợp lý với tên riêng, chỉ sử dụng ký tự in thường với danh từ chung, việt phrase và luật nhân.\n    *   Mỗi mục trong các phần phải theo định dạng \`Tiếng Trung=tiếng việt\`.\n\n**QUY TẮC TUYỆT ĐỐI**: Chỉ được trả về kết quả theo đúng định dạng đã yêu cầu, không có markdown.`;

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadState);
        
        // Gemini listeners
        dropZoneGemini.addEventListener('click', () => fileInputGemini.click());
        dropZoneGemini.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneGemini.classList.add('dragover'); });
        dropZoneGemini.addEventListener('dragleave', () => dropZoneGemini.classList.remove('dragover'));
        dropZoneGemini.addEventListener('drop', (e) => { e.preventDefault(); dropZoneGemini.classList.remove('dragover'); handleFilesGemini(e.dataTransfer.files); });
        fileInputGemini.addEventListener('change', (e) => handleFilesGemini(e.target.files));
        startBtn.addEventListener('click', () => startProcessing(false));
        resumeBtn.addEventListener('click', () => startProcessing(true));
        saveStateBtn.addEventListener('click', () => { saveState(); alert('Đã lưu phiên làm việc!'); });
        clearStateBtn.addEventListener('click', () => { if (confirm('Bạn có chắc muốn xóa toàn bộ dữ liệu và làm mới không?')) { clearState(); } });
        
        // Standardizer listeners
        runGeneratedStandardizerBtn.addEventListener('click', handleGeneratedStandardize);
        setupManualStandardizer('name');
        setupManualStandardizer('vp');
        setupManualStandardizer('rule');


        // --- State Management ---
        function saveState() {
            const state = {
                apiKeys: apiKeysInput.value,
                prompt: promptInput.value,
                files: filesToProcess.map(f => ({ name: f.name, status: f.status })),
                outputName: outputName.value,
                outputVp: outputVp.value,
                outputRule: outputRule.value,
            };
            localStorage.setItem('geminiAnalyzerState', JSON.stringify(state));
        }

        function loadState() {
            const stateJSON = localStorage.getItem('geminiAnalyzerState');
            if (stateJSON) {
                const state = JSON.parse(stateJSON);
                apiKeysInput.value = state.apiKeys || '';
                promptInput.value = state.prompt || DEFAULT_PROMPT;
                filesToProcess = state.files.map(f => ({ name: f.name, status: f.status, file: null }));
                outputName.value = state.outputName || '';
                outputVp.value = state.outputVp || '';
                outputRule.value = state.outputRule || '';
                updateFileListGeminiUI();
                updateProgressCounter();
            } else {
                promptInput.value = DEFAULT_PROMPT;
            }
        }

        function clearState() {
            localStorage.removeItem('geminiAnalyzerState');
            filesToProcess = [];
            isProcessing = false;
            apiKeysInput.value = '';
            promptInput.value = DEFAULT_PROMPT;
            outputName.value = '';
            outputVp.value = '';
            outputRule.value = '';
            fileInputGemini.value = '';

            // Clear generated standardizer results
            stdOutputName.value = ''; stdOutputName.fullContent = '';
            stdOutputVp.value = '';   stdOutputVp.fullContent = '';
            stdOutputRule.value = ''; stdOutputRule.fullContent = '';
            
            // Clear manual standardizers
            ['name', 'vp', 'rule'].forEach(type => {
                const container = document.getElementById(`standardizer-${type}`);
                container.querySelector('textarea:first-of-type').value = '';
                const outputTextarea = container.querySelector('.manual-output-textarea'); // Sửa ở đây
                outputTextarea.value = '';
                outputTextarea.fullContent = '';
                container.querySelector('.file-list').innerHTML = '';
                container.fileData = [];
            });

            updateFileListGeminiUI();
            updateProgressCounter();
        }

        // --- File Handling ---
        function handleFilesGemini(newFiles) {
            for (const file of newFiles) {
                if (!filesToProcess.some(f => f.name === file.name)) {
                     filesToProcess.push({ file: file, name: file.name, status: 'pending' });
                }
            }
            updateFileListGeminiUI();
        }

        function updateFileListGeminiUI() {
            fileListGemini.innerHTML = '';
            filesToProcess.forEach(fileData => {
                const li = document.createElement('li');
                li.className = `status-${fileData.status}`;
                li.textContent = fileData.name;
                fileListGemini.appendChild(li);
            });
        }
        
        function updateProgressCounter() {
            const successCount = filesToProcess.filter(f => f.status === 'success').length;
            const totalCount = filesToProcess.length;
            if (totalCount > 0) {
                progressCounter.textContent = `(${successCount} / ${totalCount})`;
            } else {
                progressCounter.textContent = '';
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file);
            });
        }

        // --- Core Gemini Processing Logic ---
        async function startProcessing(resumeOnly) {
            if (isProcessing) { alert('Đang trong quá trình xử lý, vui lòng đợi...'); return; }
            const apiKeys = apiKeysInput.value.trim().split('\n').filter(k => k);
            if (apiKeys.length === 0) { alert('Vui lòng nhập ít nhất một API Key.'); return; }

            let queue = resumeOnly ? filesToProcess.filter(f => f.status === 'failed') : filesToProcess.slice();
            if (resumeOnly) { queue.forEach(f => f.status = 'pending'); }
            if (queue.length === 0) { alert(resumeOnly ? 'Không có file lỗi nào để xử lý lại.' : 'Không có file nào để xử lý.'); return; }
            
            isProcessing = true;
            startBtn.disabled = true;
            resumeBtn.disabled = true;

            for (const fileData of queue) {
                if (!fileData.file) {
                    alert(`Không tìm thấy dữ liệu file cho "${fileData.name}". Vui lòng thêm lại file này.`);
                    fileData.status = 'failed';
                    updateFileListGeminiUI();
                    continue;
                }
                
                fileData.status = 'processing';
                updateFileListGeminiUI();

                try {
                    const content = await readFileAsText(fileData.file);
                    const resultText = await callGeminiAPI(content, apiKeys, promptInput.value);
                    parseAndAppendResult(resultText, fileData.name);
                    fileData.status = 'success';
                } catch (error) {
                    console.error(`Lỗi khi xử lý file ${fileData.name}:`, error);
                    fileData.status = 'failed';
                }
                updateFileListGeminiUI();
                updateProgressCounter();
            }

            isProcessing = false;
            startBtn.disabled = false;
            resumeBtn.disabled = false;
            saveState();
            alert('Đã xử lý xong!');
        }
        
        async function callGeminiAPI(content, apiKeys, prompt, keyIndex = 0) {
            if (keyIndex >= apiKeys.length) { throw new Error("Tất cả API Key đều đã thất bại."); }
            const apiKey = apiKeys[keyIndex];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const full_prompt = `${prompt}\n\n---\n\n${content}`;
            
            const body = {
                "contents": [{ "parts": [{ "text": full_prompt }] }],
                "generationConfig": { "temperature": 0.5, "topK": 1, "topP": 1, "maxOutputTokens": 65536 },
                "safetySettings": [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" } ]
            };

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                         return result.candidates[0].content.parts[0].text; 
                    }
                }
                console.warn(`API Key ${keyIndex + 1} thất bại (HTTP ${response.status} hoặc không có nội dung). Thử key tiếp theo.`);
                return await callGeminiAPI(content, apiKeys, prompt, keyIndex + 1);
            } catch (error) {
                console.warn(`Ngoại lệ với API Key ${keyIndex + 1}: ${error}. Thử key tiếp theo.`);
                return await callGeminiAPI(content, apiKeys, prompt, keyIndex + 1);
            }
        }

        function parseAndAppendResult(geminiText, sourceFileName) {
            if (!geminiText) {
                console.warn(`Không có nội dung trả về từ Gemini cho file ${sourceFileName}.`);
                return;
            }
            const separator = `\n\n--- Kết quả từ file: ${sourceFileName} ---\n\n`;
            const nameMarker = "- tên:"; const vpMarker = "- việt phrase:"; const ruleMarker = "- luật nhân:";
            
            let nameContent = '', vpContent = '', ruleContent = '';

            let sortedIndices = [
                { marker: nameMarker, index: geminiText.indexOf(nameMarker) },
                { marker: vpMarker, index: geminiText.indexOf(vpMarker) },
                { marker: ruleMarker, index: geminiText.indexOf(ruleMarker) }
            ].filter(i => i.index !== -1).sort((a, b) => a.index - b.index);

            if (sortedIndices.length > 0) {
                for(let i = 0; i < sortedIndices.length; i++) {
                    const current = sortedIndices[i];
                    const next = sortedIndices[i+1];
                    const content = geminiText.substring(current.index + current.marker.length, next ? next.index : undefined).trim();

                    if(current.marker === nameMarker) nameContent = content;
                    else if(current.marker === vpMarker) vpContent = content;
                    else if(current.marker === ruleMarker) ruleContent = content;
                }
            } else {
                 nameContent = geminiText;
            }

            if (nameContent) outputName.value += (outputName.value ? separator : '') + nameContent;
            if (vpContent) outputVp.value += (outputVp.value ? separator : '') + vpContent;
            if (ruleContent) outputRule.value += (outputRule.value ? separator : '') + ruleContent;
        }

        // ================================================================
        // === LOGIC CHUẨN HÓA MỚI - TÍCH HỢP TỪ FILE VP.HTML ===
        // ================================================================

        const VIETNAMESE_CHARS = 'àáâãèéêìíòóôõùúăđĩũơưạảấầẩẫậắằẳẵặẹẻẽếềểễệỉịọỏốồổỗộớờởỡợụủứừửữựỳýỵỷỹ';
        // *** SỬA LỖI 2: Thêm \\{\\} để cho phép ký tự {} ***
        const ALLOWED_CHARS_REGEX = new RegExp(`^[\u4E00-\u9FFFa-zA-Z0-9=\\s\\{\\}${VIETNAMESE_CHARS}${VIETNAMESE_CHARS.toUpperCase()}]+$`);

        function containsChinese(text) { return /[\u4E00-\u9FFF]/.test(text); }
        function containsSpecialChars(text) { return !ALLOWED_CHARS_REGEX.test(text); }
        function isUpperCaseChar(char) { return char.toLowerCase() !== char && char.toUpperCase() === char; }
        function isTitleCase(text) {
            const words = text.trim().split(/\s+/);
            if (!words[0]) return true;
            return words.every(word => word.length === 0 || isUpperCaseChar(word[0]));
        }

        function advancedStandardizeText(inputText, options) {
            if (!inputText || !inputText.trim()) return '';
            
            const uniqueEntries = new Map();
            const allLines = inputText.split('\n');
            for (const line of allLines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine.startsWith('---')) continue;
                const separatorIndex = trimmedLine.indexOf('=');
                if (separatorIndex === -1) continue;
                const key = trimmedLine.substring(0, separatorIndex).trim();
                const value = trimmedLine.substring(separatorIndex + 1).trim();
                if (key && !uniqueEntries.has(key)) {
                    uniqueEntries.set(key, value);
                }
            }

            const resultLines = [];
            for (const [key, value] of uniqueEntries.entries()) {
                const currentLine = `${key}=${value}`;
                if (!containsChinese(currentLine)) continue;
                if (options.removeSpecialChars && containsSpecialChars(currentLine)) continue;
                
                if (isTitleCase(value)) {
                    resultLines.push(currentLine);
                } else {
                    resultLines.push(`${key}=${value.toLowerCase()}`);
                }
            }
            return resultLines.sort().join('\n'); // Thêm .sort() để kết quả dễ nhìn hơn
        }

        function createContentPreview(fullContent, maxLines = 200) {
            if (!fullContent) return 'Không có nội dung.';
            const lines = fullContent.split('\n');
            if (lines.length <= maxLines) return fullContent;
            
            const preview = lines.slice(0, maxLines).join('\n');
            return `${preview}\n\n--- (Hiển thị ${maxLines} trên tổng số ${lines.length} dòng) ---`;
        }

        function handleGeneratedStandardize() {
            if (!outputName.value && !outputVp.value && !outputRule.value) {
                alert('Chưa có dữ liệu nào được tạo từ Gemini để chuẩn hoá.');
                return;
            }
             const options = { removeSpecialChars: removeSpecialCharsToggle.checked };

            const fullResultName = advancedStandardizeText(outputName.value, options);
            stdOutputName.fullContent = fullResultName;
            stdOutputName.value = createContentPreview(fullResultName);

            const fullResultVp = advancedStandardizeText(outputVp.value, options);
            stdOutputVp.fullContent = fullResultVp;
            stdOutputVp.value = createContentPreview(fullResultVp);

            const fullResultRule = advancedStandardizeText(outputRule.value, options);
            stdOutputRule.fullContent = fullResultRule;
            stdOutputRule.value = createContentPreview(fullResultRule);

            alert('Đã chuẩn hoá xong dữ liệu từ Gemini!');
        }

        function setupManualStandardizer(type) {
            const container = document.getElementById(`standardizer-${type}`);
            const inputTextArea = container.querySelector('textarea:first-of-type');
            const dropZone = container.querySelector('.drop-zone');
            const fileInput = container.querySelector('.file-input-hidden');
            const fileList = container.querySelector('.file-list');
            const standardizeBtn = container.querySelector('.button-group button');
            // *** SỬA LỖI 1: Sử dụng class 'manual-output-textarea' để chọn chính xác ***
            const outputTextArea = container.querySelector('.manual-output-textarea');
            const copyBtn = container.querySelector('.output-header .button-group button:first-child');
            const downloadBtn = container.querySelector('.output-header .button-group button:last-child');
            
            container.fileData = [];

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); e.target.value = ''; });

            function handleFiles(newFiles) {
                for (const file of newFiles) {
                    if (!container.fileData.some(f => f.name === file.name)) {
                        container.fileData.push({ file: file, name: file.name });
                    }
                }
                updateUI();
            }

            function updateUI() {
                fileList.innerHTML = '';
                container.fileData.forEach(f => {
                    const li = document.createElement('li');
                    li.textContent = f.name;
                    fileList.appendChild(li);
                });
            }

            standardizeBtn.addEventListener('click', async () => {
                let combinedText = inputTextArea.value;
                for (const fileData of container.fileData) {
                    try {
                        const fileContent = await readFileAsText(fileData.file);
                        combinedText += "\n" + fileContent;
                    } catch (error) { alert(`Lỗi đọc file ${fileData.name}`); }
                }

                const options = { removeSpecialChars: removeSpecialCharsToggle.checked };
                const fullResult = advancedStandardizeText(combinedText, options);

                outputTextArea.fullContent = fullResult;
                outputTextArea.value = createContentPreview(fullResult);
                alert(`Đã chuẩn hoá xong ${type.toUpperCase()}!`);
            });

            copyBtn.addEventListener('click', () => copyToClipboard(outputTextArea));
            downloadBtn.addEventListener('click', () => downloadAsFile(outputTextArea, `${type}_manual_std.txt`));
        }

        // --- Utility Functions (Updated) ---
        function copyToClipboard(element) {
            const textarea = (typeof element === 'string') ? document.getElementById(element) : element;
            const contentToCopy = textarea.fullContent !== undefined ? textarea.fullContent : textarea.value;

            // navigator.clipboard is a more modern and reliable API
            if (navigator.clipboard && window.isSecureContext) {
                 navigator.clipboard.writeText(contentToCopy).then(() => {
                    alert('Đã copy nội dung!');
                }).catch(err => {
                    console.error('Không thể copy bằng Clipboard API, thử cách cũ...', err);
                    legacyCopy(contentToCopy);
                });
            } else {
                 legacyCopy(contentToCopy);
            }
        }

        function legacyCopy(text) {
             const tempTextarea = document.createElement('textarea');
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            alert('Đã copy nội dung!');
        }

        function downloadAsFile(element, filename) {
            const textarea = (typeof element === 'string') ? document.getElementById(element) : element;
            const contentToDownload = textarea.fullContent !== undefined ? textarea.fullContent : textarea.value;

            const blob = new Blob([contentToDownload], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
    </script>
</body>
</html>